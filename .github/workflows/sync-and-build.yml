name: 'Sync JBR & Build RTL Fix'

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  UPSTREAM_REPO: 'https://github.com/JetBrains/JetBrainsRuntime.git'
  RTL_FIX_COMMIT: 'b406c1a471'

jobs:

  check-release:
    name: 'Check for new JBR release'
    runs-on: ubuntu-24.04
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      release-tag: ${{ steps.check.outputs.release-tag }}
      rtl-tag: ${{ steps.check.outputs.rtl-tag }}

    steps:
      - name: 'Find latest JBR 25.x release'
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # List jbr-release-25.* tags from upstream and pick the latest
          latest_tag=$(git ls-remote --tags "$UPSTREAM_REPO" 'refs/tags/jbr-release-25.*' \
            | awk '{print $2}' \
            | sed 's|refs/tags/||' \
            | grep -v '\^{}' \
            | sort -V \
            | tail -1)

          if [[ -z "$latest_tag" ]]; then
            echo "No jbr-release-25.x tags found upstream"
            echo "should-build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest upstream tag: $latest_tag"

          # Derive the RTL tag name (e.g. jbr-release-25.0.2b329.66 â†’ v25.0.2b329.66-rtl)
          rtl_tag="$(echo "$latest_tag" | sed 's/^jbr-release-/v/')-rtl"
          echo "RTL tag: $rtl_tag"

          # Check if this tag already exists in our fork
          if gh api "repos/${{ github.repository }}/git/ref/tags/$rtl_tag" >/dev/null 2>&1; then
            echo "Tag $rtl_tag already exists, skipping"
            echo "should-build=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected, will build"
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "release-tag=$latest_tag" >> $GITHUB_OUTPUT
            echo "rtl-tag=$rtl_tag" >> $GITHUB_OUTPUT
          fi

  prepare-branch:
    name: 'Prepare RTL branch'
    needs: check-release
    if: needs.check-release.outputs.should-build == 'true'
    runs-on: ubuntu-24.04

    steps:
      - name: 'Checkout fork'
        uses: actions/checkout@v4

      - name: 'Create RTL branch from upstream release'
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.check-release.outputs.release-tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add upstream remote and fetch the release tag
          git remote add upstream "$UPSTREAM_REPO"
          git fetch --depth=1 --no-tags upstream "refs/tags/$RELEASE_TAG:refs/tags/$RELEASE_TAG"

          # Create a new branch from the upstream release tag
          git checkout -b "rtl/$RELEASE_TAG" "$RELEASE_TAG"

          # Download the RTL fix as a patch via GitHub API and apply it
          gh api "repos/${{ github.repository }}/commits/$RTL_FIX_COMMIT" \
            -H "Accept: application/vnd.github.patch" > /tmp/rtl-fix.patch
          git am /tmp/rtl-fix.patch

          # Push the branch (force in case of a previous failed run)
          git push -f origin "rtl/$RELEASE_TAG"

  build-macos:
    name: 'Build ${{ matrix.platform }}'
    needs: [check-release, prepare-branch]
    if: needs.check-release.outputs.should-build == 'true'
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-aarch64
            runs-on: macos-26
          - platform: macos-x64
            runs-on: macos-26

    steps:
      - name: 'Checkout RTL branch'
        uses: actions/checkout@v4
        with:
          ref: 'rtl/${{ needs.check-release.outputs.release-tag }}'

      - name: 'Get the BootJDK'
        id: bootjdk
        uses: ./.github/actions/get-bootjdk
        with:
          platform: ${{ matrix.platform }}

      - name: 'Get GTest'
        id: gtest
        uses: ./.github/actions/get-gtest

      - name: 'Install toolchain and dependencies'
        run: |
          brew install autoconf make

          # Select latest Xcode
          XCODE_APP=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          [ -z "$XCODE_APP" ] && XCODE_APP="/Applications/Xcode.app"
          echo "Using Xcode: $XCODE_APP"
          sudo xcode-select --switch "$XCODE_APP/Contents/Developer"

          # Add Xcode toolchain bin to PATH so configure finds metal directly
          TOOLCHAIN_BIN="$XCODE_APP/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin"
          echo "Adding toolchain bin: $TOOLCHAIN_BIN"
          echo "$TOOLCHAIN_BIN" >> $GITHUB_PATH

          # Make GNU make available as 'make'
          echo "$(brew --prefix)/opt/make/libexec/gnubin" >> $GITHUB_PATH

      - name: 'Configure'
        run: >
          bash configure
          --with-conf-name=${{ matrix.platform }}
          --with-version-opt=${GITHUB_ACTOR}-${GITHUB_SHA}
          --with-boot-jdk=${{ steps.bootjdk.outputs.path }}
          --with-gtest=${{ steps.gtest.outputs.path }}
          --with-zlib=system
          --with-jmod-compress=zip-1
          || (echo "Dumping config.log:" && cat config.log && exit 1)

      - name: 'Build'
        id: build
        uses: ./.github/actions/do-build
        with:
          make-target: 'product-bundles'
          platform: ${{ matrix.platform }}

      - name: 'Upload bundles'
        uses: ./.github/actions/upload-bundles
        with:
          platform: ${{ matrix.platform }}

  create-release:
    name: 'Create GitHub Release'
    needs: [check-release, build-macos]
    if: needs.check-release.outputs.should-build == 'true'
    runs-on: ubuntu-24.04

    steps:
      - name: 'Download macOS aarch64 bundles'
        uses: actions/download-artifact@v4
        with:
          name: bundles-macos-aarch64
          path: artifacts/macos-aarch64

      - name: 'Download macOS x64 bundles'
        uses: actions/download-artifact@v4
        with:
          name: bundles-macos-x64
          path: artifacts/macos-x64

      - name: 'Create release'
        env:
          GH_TOKEN: ${{ github.token }}
          RTL_TAG: ${{ needs.check-release.outputs.rtl-tag }}
          RELEASE_TAG: ${{ needs.check-release.outputs.release-tag }}
        run: |
          echo "=== macOS aarch64 bundles ==="
          ls -lh artifacts/macos-aarch64/
          echo "=== macOS x64 bundles ==="
          ls -lh artifacts/macos-x64/

          # Build release notes
          {
            echo "JBR build with RTL fix for macOS CustomTitleBar."
            echo ""
            echo "Based on upstream release \`$RELEASE_TAG\` with RTL fix cherry-picked (commit \`$RTL_FIX_COMMIT\`)."
            echo ""
            echo "### Assets"
            echo "- **macOS aarch64** (Apple Silicon)"
            echo "- **macOS x64** (Intel)"
          } > release-notes.md

          gh release create "$RTL_TAG" \
            --repo "${{ github.repository }}" \
            --target "rtl/$RELEASE_TAG" \
            --title "$RTL_TAG" \
            --notes-file release-notes.md \
            artifacts/macos-aarch64/*.tar.gz \
            artifacts/macos-x64/*.tar.gz
